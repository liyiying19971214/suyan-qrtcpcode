<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<title>websocket通讯</title>
</head>
<style>
html {
    height: 90%;
    overflow: auto;
    vertical-align: middle;
}

body {
    min-height: 90%;
}

div {
    margin: 20px 0;
    height: 50px;
    line-height: 50px;
}

.pro-process-content-li {
    width: 33%;
    height: 100%;
    float: left;
    position: relative;
}

.pro-process-content-list {
    width: 80%;
    height: 263px;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    margin: auto;
    text-align: center;
}
table {
    border:1px solid #000;
    width:98%;

}
tr td:first-child {
}
td {
    text-align: center;
    vertical-align: middle;
    height:50px;
    width:49%;
}
.black{
    display: none;
    position: fixed;
    width: 100%;
    height: 100%;
    z-index: 2;
    background: rgba(0,0,0,0.1);
    top:0;
    left:0;
}
.dialog{
    display: none;
    position: fixed;
    z-index: 3;
    width: 500px;
    min-height: 400px;
    top:50%;
    left:50%;
    margin: -150px 0 0 -250px;
    background: #fff;
    padding: 15px;
    border-radius: 5px;
}

/* 按钮btn 基础样式 */


.btn-list {
    display: grid;
    grid-template-columns: repeat(3,200px);
    gap: 50px;
    background: #fff;
    border-radius: 20px;
    padding: 50px;
    box-shadow: 0 0 5px 5px rgb(0 0 0 / 8%);
}

.btn {
    width: 200px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    cursor: pointer;
    margin: auto;
    user-select: none;
    letter-spacing: 1rem;
    text-indent: 1rem;
    border-radius: 20px;
    box-sizing: border-box;
}
.three-d {
    color: #fff;
    background-color: #f1c40f;
    text-shadow: -2px 2px 2px rgb(209 132 0),
                -2px 2px 2px rgb(209 132 0),
                -2px 2px 2px rgb(209 132 0),
                -2px 2px 2px rgb(209 132 0),
                -2px 2px 2px rgb(209 132 0),
                -2px 2px 2px rgb(209 132 0);
    box-shadow: 0px 15px 0px 0px #f39c12;
    transition: all .5s;
}

.three-d:hover {
    background-color: #fcdc5e;
}

.three-d:active {
    transform: translate(0,4px);
    box-shadow: 0px 1px 0px 0px #f39c12;
}



.modal {
    display: none;
    position: fixed;
    z-index: 100;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

/*模态框公共样式*/
.modal-content {
    background-color: #fefefe;
    margin: 50px auto 0;
    padding: 20px;
    border: 1px solid #888;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    animation: modal-show 0.3s;
}



/* 迷你大小 */
.modal-mini {
    width: 250px;
    height: 100px;
}







/* ----------------------------------------------
 * Generated by Animista on 2024-1-16 15:31:51
 * Licensed under FreeBSD License.
 * See http://animista.net/license for more info.
 * w: http://animista.net, t: @cssanimista
 * ---------------------------------------------- */

/* ----------------------------------------------
 * Generated by Animista on 2024-1-16 15:33:52
 * Licensed under FreeBSD License.
 * See http://animista.net/license for more info.
 * w: http://animista.net, t: @cssanimista
 * ---------------------------------------------- */

/**
 * ----------------------------------------
 * animation fade-in-bottom
 * ----------------------------------------
 */
@-webkit-keyframes fade-in-bottom {
    0% {
        -webkit-transform: translateY(10px);
        transform: translateY(10px);
        opacity: 0;
    }
    100% {
        -webkit-transform: translateY(0);
        transform: translateY(0);
        opacity: 1;
    }
}
@keyframes fade-in-bottom {
    0% {
        -webkit-transform: translateY(10px);
        transform: translateY(10px);
        opacity: 0;
    }
    100% {
        -webkit-transform: translateY(0);
        transform: translateY(0);
        opacity: 1;
    }
}


.fade-in-bottom {
    -webkit-animation: fade-in-bottom 1s cubic-bezier(0.390, 0.575, 0.565, 1.000) infinite ;
    animation: fade-in-bottom 1s cubic-bezier(0.390, 0.575, 0.565, 1.000) infinite ;
}



.dot {
    animation: blink 2s infinite;
}
.dot1 {
    animation: blink 3s infinite;
}
.dot2 {
    animation: blink 4s infinite;
}

@keyframes blink {
    0%{
        opacity: 0;
    }
    50% {
        opacity: 1;
    }

}




</style>

<script th:src="@{../framework/jquery-2.1.1.min.js}"></script>

<script th:inline="javascript" type="text/javascript">
    var ctxPath=[[${#httpServletRequest.getContextPath()}]];
    $(function() {
        //这里用来记录key的值
        $.ajax({
            type : 'POST',
            url : ctxPath+'/printerController/getDeviceStatus',// 请求的action路径
            dataType:"json",
            error : function() {// 请求失败处理函数
            },
            success : function(result) {
                for(var key in result){
                    setData(key,result[key]);
                }
            }
        });

        $.ajax({
            type : 'POST',
            url : ctxPath+'/printerController/getSessionConfig',// 请求的action路径
            dataType:"json",
            error : function() {// 请求失败处理函数
            },
            success : function(result) {
                if(result.success){
                    //插入值
                    let  btList=result.obj.btList;
                    let  bmList=result.obj.bmList;
                    for(let bt of btList ){
                        var option = new Option(bt.modelName,bt.id);
                        option.dataset.domainName=bt.domainName;
                        option.dataset.factoryCode=bt.factoryCode;
                        $("#bucketTypeId")[0].options.add(option);
                    }
                    for(let bm of bmList){
                        $("#bucketMode")[0].options.add(new  Option(bm.value,bm.key));
                    }
                    //给页面赋值
                    $("#bucketTypeIdValue").text(result.obj.bucketTypeIdValue);
                    $("#bucketModeValue").text(result.obj.bucketModeValue);
                    $("#bucketDmValue").text(result.obj.bucketDmValue);
                    $("#print_cnt").text(result.obj.print_cnt);
                    changeSelect();
                }else{
                    alert(result.msg);
                }
            }

        });

        openSocket();


    });

    /**
     * 这里是进行内容
     */
    function create_paper_save(){
        $("#loading").show();
        //打开model框
        openModal();

        // 获取表单数据
        const formData = {
            bucketTypeId: $('#bucketTypeId').val(), // 获取 input 的值
            bucketModeId: $('#bucketMode').val(),
            myCheckbox: $('#addIdCheckbox').is(':checked'), // 获取 checkbox 的状态
            domainName: $('#selectedInput').val(),
        };

        //进行提交表单
        $.ajax({
            type:'post',
            dataType:"json",
            url: ctxPath+'/printerController/saveConfig',
            contentType: 'application/json', // 设置请求头为 JSON
            data: JSON.stringify(formData),
            success:function (data){
                //弹出内容框
                console.log(data);
                if(data!=null){
                   if(data.success){
                       //关闭页面
                       create_paper_cancel();
                       //刷新对应的内容
                       window.location.reload();
                   }
                   alert(data.msg);
                }
            },
            complete :function (){
                closeModal();
            }
        })
    }

    function setData(msgtype,value){
        $thistype=$('#'+msgtype);
        if(msgtype=='printer_status' || msgtype=='cellphone_status'){
            if(value){
                $thistype.find('img').attr('src','/img/terminal_conn.png');
                $thistype.find('font').html('已连接');
            }else{
                $thistype.find('img').attr('src','/img/terminal_disconn.png');
                $thistype.find('font').html('未连接');
            }

        }else if(msgtype=='printer_ready'){
            if(value){
                $thistype.html('<font style="color: green;">打印机已就绪</font>');
            }else{
                $thistype.html('<font style="color: red;">打印机未就绪</font>');
            }
        }else if(msgtype=="printer_upload_status"){
            //显示上传动画效果
            if(value==0){
                closeUpload(value)
            }else{
                openUpload(value)
            }
        }else if(msgtype=="server_send_msg"){
            alert(value);
        }else if(msgtype=='data_transfer'){
            if(value)
                $thistype.show();
            else
                $thistype.hide();
        }else if(msgtype=='generate_bucket'){
        	 if(value){
        	      $("#generateBucket").css('display','');
                  //数量增加
                 let currentCount = parseInt($('#print_cnt').text(), 10)//转化成10进制
                 currentCount += 1;
                 $("#print_cnt").text(currentCount);
        	 }else{
                 $("#generateBucket").css('display','none');
        	 }
        }else if(msgtype=="generate_bucket_msg"){
            $("#printer_ready").html('<font style="color: blue;">'+value+'</font>');
        }else{
            $thistype.html(value);
        }
    }


    /**
     * model打开动画
     */
    function openModal(){
        $("#myModal").css('display','block');
    }


    /**
     * model关闭动画
     */
    function  closeModal(){
        $("#myModal").css('display','none');
    }

    /**
     * 打开动画内容
     */
    function openUpload(value){
        $("#uploadImg").addClass("fade-in-bottom");
        $("#uploadNum").html(value);
    }

    /**
     * 关闭动画
     * @param value
     */
    function   closeUpload(value){
        $("#uploadImg").removeClass("fade-in-bottom");
        $("#uploadNum").html(value);
    }

    var socket;
    function openSocket() {
        if (typeof (WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");ba
        } else {
            console.log("您的浏览器支持WebSocket");
            //实现化WebSocket对象，指定要连接的服务器地址与端口  建立连接
            //等同于socket = new WebSocket("ws://localhost:8888/xxxx/im/25");
            var socketUrl = "ws://localhost:9999/deviceDataSck";
            socketUrl = socketUrl.replace("https", "ws").replace("http", "ws");
            if (socket != null) {
                socket.close();
                socket = null;
            }
            socket = new WebSocket(socketUrl);
            //打开事件
            socket.onopen = function() {
                console.log("websocket已打开");
                //socket.send("这是来自客户端的消息" + location.href + new Date());
            };
            //获得消息事件
            socket.onmessage = function(msg) {
                var data=JSON.parse(msg.data);
                for(var key in data){
                    setData(key,data[key]);
                }
            };
            //关闭事件
            socket.onclose = function() {
                alert("页面连接丢失,请确保服务启动并重新刷新本页");
            };
            //发生了错误事件
            socket.onerror = function() {
                console.log("websocket发生了错误");
            }
        }
    }
    function sendMessage() {
        if (typeof (WebSocket) == "undefined") {
            alert("您的浏览器不支持WebSocket");
        } else {
            socket.send('{"msgtype":"set_not_ready","value":""}');
            //socket.send('{"haha":"hha"}');
        }
    }

    //生成水桶信息
    function scrapBucket(){
    	//拿到对应的信息去生成水桶信息
    	 var qrCode=$("#printer_receive_msg").text();
    	console.log(qrCode);//打印数值
    	  if (typeof (WebSocket) == "undefined") {
              alert("您的浏览器不支持WebSocket");
          } else {
              socket.send('{"msgtype":"set_scrap_bucket","value":""}');
          }
    }

    //打开到新的界面内容
    function  printConfiguration(){
        //open new  page
        $("#black").css('display','block');
        $("#my_dialog").css('display','block');
    }

    function create_paper_cancel(){
        closeModal();

        $("#black").css('display','none');
        $("#my_dialog").css('display','none');
    }

    /**
     * 单选框添加数据
     */
    function addFactoryCode(){
        var isChecked = $("#addIdCheckbox").prop("checked");

        const selectedOption = $("#bucketTypeId").find('option:selected');
        const domainName = selectedOption.data('domainName');
        const cbfactoryCode = selectedOption.data('factoryCode');

        if(isChecked){
            $("#selectedInput").val(domainName + cbfactoryCode);
        }else{
            $("#selectedInput").val(domainName);
        }

    }

    /**
     * 清空选择按钮
     */
    function  clearCheckBox(){
        $("#addIdCheckbox").prop("checked", false);
    }

    /**
     * 选择框选中事件
     */
    function  changeSelect(){

        clearCheckBox();
        addFactoryCode();


    }


</script>
<body style="width:100%;height:100%;">
    <!-- Dialog的内容信息-->
    <div class="black" id="black"></div>
    <div id="myModal" class="modal">
        <div class="modal-content modal-mini">
            <h4>数据加载中请等待<span class="dot">。</span><span class="dot1">。</span><span class="dot2">。</span></h4>
        </div>
    </div>

    <div id="my_dialog" class="dialog" title="配置二维码打印配置">

        <!-- 表单使用Thymeleaf语法 -->
        <span>配置二维码打印配置</span>
        <span class="dialog_close" style="display: inline-block;padding-left: 470px;border-bottom: 1px solid #eee;"></span>
        <form id="configForm" method="post" th:action="@{##}" onsubmit="return false">
            <p>水桶类型：
                <select id="bucketTypeId" name="bucketTypeId"  onchange="changeSelect()" >
                    <!-- 使用Thymeleaf语法进行循环渲染选项 -->
                    <option th:each="so : ${soList}" th:value="${so.key}" th:text="${so.value}"></option>
                </select>
            </p>
            <p>打印方式：
                <select id="bucketMode" name="bucketMode">
                    <!-- 使用Thymeleaf语法进行循环渲染选项 -->
                    <option th:each="bm : ${bmList}" th:value="${bm.key}" th:text="${bm.value}"></option>
                </select>
            </p>二维码前缀:
                <input id="selectedInput" type="text" readonly >
                <!-- 是否添加ID的单选框 -->
                <label>
                    <input type="checkbox" id="addIdCheckbox" onchange="addFactoryCode()"> 拼接水桶Code编号
                </label>
            <p>


            </p>
            <div style="float: right;">
                <button class="my-btn-gray" type="button" onclick="create_paper_cancel()">取消</button>
                <button class="my-btn-blue" type="button" onclick="create_paper_save()">保存</button>
            </div>
        </form>
    </div>

    <div style="position: absolute;z-index: 9999;left: 48%;top:100px;display:none;" id="data_transfer">
        <img th:src="@{/img/transfer.png}" style="width:50px;height:50px;"></img>
    </div>

    <table>
        <tr>
            <td colspan="2">
                今日已扫描：
                <span  type="color:red"  id="print_cnt"></span>
                水桶类型：
                <span  type="color:red" id="bucketTypeIdValue"></span>
                采集方式：
                <span  type="color:red"  id="bucketModeValue"></span>
                二维码前缀：
                <span  type="color:red"  id="bucketDmValue"></span>
                上传剩余数：
                <span id="uploadNum" style="color:gray;">0</span>
            </td>

        </tr>
        <tr>
            <td>阅读器状态</td>
            <td>打印机状态</td>
        </tr>
        <tr>
            <td>
                <img   th:src="@{/img/scanner.png}"
                    style="width:auto;height:100%;"></img>
            </td>
            <td>
                <img  th:src="@{/img/printer.jpg}"
                    style="width:auto;height:100%;"></img>
                <img  id="uploadImg"   th:src="@{/img/upload.png}"  style="width: 20px;height: 20px;margin-bottom: 10px;"/>
            </td>
        </tr>
        <tr>
        <td id="cellphone_ip">
        </td>
        <td  id="printer_ip">
        </td>
        </tr>

        <tr >
            <td >
                <span id="cellphone_status">
                    <img th:src="@{/img/terminal_disconn.png}"
                        style="width:auto;height:70%;margin-top:5px;"></img>
                    <font>未连接</font>
                </span>
            </td>
            <td>
                <span id="printer_status">
                    <img   th:src="@{/img/terminal_disconn.png}"
                            style="width:auto;height:70%;"></img>
                    <font style="height:100%;">未连接</font>
                </span>

            </td>
        </tr>
        <tr>
            <td>
                收到信息：
            </td>
            <td>
                发送信息：
            </td>
        </tr>
        <tr>
            <td id="cellphone_send_msg">

            </td>
            <td  id="printer_receive_msg">

            </td>
        </tr>

        <tr id="generateBucket"    style="display: none">
            <td>
            </td>
            <td>
                    <div class="btn three-d"  onclick="scrapBucket()">报废</div>
            </td>
        </tr>

        <tr>
            <td colspan="2" id="printer_ready">
                <font style="color: red;">打印机未就绪</font>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <input type="button" value="取消打印就绪" onclick="sendMessage()"/>
                <input type="button" value="配置打印内容" onclick="printConfiguration()"/>
            </td>
        </tr>

        <tr>
            <td colspan="2">
                <span id="error_msg"></span>
            </td>
        </tr>
    </table>
</body>

</html>
